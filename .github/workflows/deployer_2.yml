name: ðŸš€ System Checker ðŸ˜ŽðŸ”¥

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: "ultra-deluxe"
  cancel-in-progress: false

jobs:
  # ==================================
  # ðŸ§ª JOB 1 â€” MULTI-OS PROJECT AUDIT
  # ==================================
  audit:
    name: ðŸ§ª Audit & File Scan (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“‚ List Files (Recursive)
        run: |
          echo "===== FILE LIST ====="
          ls -R

      - name: ðŸŒ³ Tree View + Save to File
        shell: bash
        run: |
          if command -v tree; then
            tree -a | tee tree.txt
          else
            echo "tree not installed, using ls" | tee tree.txt
            ls -R | tee -a tree.txt
          fi

      - name: ðŸ§¾ Root Summary
        run: |
          pwd
          ls -lah

      - name: ðŸ§  System & Hardware Info
        shell: bash
        run: |
          uname -a || ver
          echo "CPU Info:"
          lscpu || echo "Windows CPU info skipped"

      - name: ðŸ›¡ï¸ Disk Usage
        shell: bash
        run: df -h || echo "Disk info skipped on Windows"

      - name: ðŸ“¦ Upload Tree Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tree-${{ matrix.os }}
          path: tree.txt

  # ==================================
  # ðŸš€ JOB 2 â€” BUILD, SECURITY & QA
  # ==================================
  build-secure:
    name: ðŸš€ Build, Security & QA
    runs-on: ubuntu-latest
    needs: audit

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ðŸ”¢ Node & npm Versions
        run: |
          node -v
          npm -v

      - name: ðŸ“¦ Install Dependencies (Safe)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "No package.json â€” skipping install"
          fi

      - name: ðŸ›¡ï¸ npm Audit (Security Scan)
        run: |
          if [ -f package.json ]; then
            npm audit --audit-level=high || echo "âš ï¸ Vulnerabilities found"
          else
            echo "Skipping audit"
          fi

      - name: ðŸ§ª Tests (if exist)
        run: |
          if npm run | grep -q test; then
            npm test
          else
            echo "No tests configured"
          fi

      - name: ðŸ§¹ Lint (if exist)
        run: |
          if npm run | grep -q lint; then
            npm run lint
          else
            echo "No lint configured"
          fi

      - name: ðŸ—ï¸ Build (if exist)
        run: |
          if npm run | grep -q build; then
            npm run build
          else
            echo "No build configured"
          fi

      - name: ðŸ“„ Generate Build Report
        run: |
          echo "Build Report" > build-report.txt
          date >> build-report.txt
          echo "Node: $(node -v)" >> build-report.txt
          echo "NPM: $(npm -v)" >> build-report.txt
          du -sh . >> build-report.txt

      - name: ðŸ“¦ Upload Build Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.txt

      - name: ðŸŽ‰ Final Status
        run: echo "ULTRA DELUXE PIPELINE COMPLETE ðŸš€ðŸ”¥"
