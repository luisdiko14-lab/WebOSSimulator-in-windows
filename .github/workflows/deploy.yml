name: ğŸš€ Ultra Clean Zero-Error Deploy PRO+

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # =========================
  # ğŸ” PRECHECK JOB
  # =========================
  precheck:
    name: ğŸ” Precheck & Repo Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ—‚ï¸ List All Files (Tree)
        run: |
          echo "ğŸ“ FULL FILE TREE:"
          find . -type f
          echo "âœ… File tree scan complete!"

      - name: ğŸ§¾ Validate package.json
        run: |
          if [ -f package.json ]; then
            echo "âœ… package.json found!"
            cat package.json
          else
            echo "âš ï¸ No package.json found!"
          fi

      - name: ğŸ§ª Validate Python Files
        run: |
          if ls *.py 1> /dev/null 2>&1; then
            echo "âœ… Python files detected"
          else
            echo "â„¹ï¸ No Python files detected"
          fi

  # =========================
  # ğŸ”¨ BUILD JOB
  # =========================
  build:
    name: ğŸ”¨ Build & Prepare Site
    runs-on: ubuntu-latest
    needs: precheck
    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install npm Dependencies
        run: |
          echo "ğŸ“¦ Installing npm dependencies..."
          npm install || echo "âš ï¸ npm install failed!"

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: ğŸ“¦ Install Python Packages
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: ğŸ› ï¸ Run Build Script
        run: |
          if grep -q '"build"' package.json; then
            echo "ğŸ› ï¸ Running build..."
            npm run build
          else
            echo "â„¹ï¸ No build script found."
          fi

      - name: ğŸ§ª Run Dev Script
        run: |
          if grep -q '"dev"' package.json; then
            echo "ğŸ–¥ï¸ Running dev script..."
            npm run dev || echo "âš ï¸ Dev script failed!"
          else
            echo "â„¹ï¸ No dev script found."
          fi

      - name: ğŸ”’ Run Security Scan
        run: |
          if [ -f package.json ]; then
            echo "ğŸ” Running npm audit..."
            npm audit || echo "âš ï¸ Audit issues found!"
          fi

      - name: âš™ï¸ Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  # =========================
  # ğŸ§ª FILE INSPECTOR JOB
  # =========================
  inspector:
    name: ğŸ§ª Deep File Inspector
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ§¾ Show index.html With Line Numbers
        run: |
          if [ -f index.html ]; then
            nl -ba index.html
          else
            echo "âŒ index.html NOT FOUND!" && exit 1
          fi

      - name: ğŸš¨ HTML Tag Scan
        run: |
          for tag in html head body; do
            grep -n "<$tag" index.html || echo "âš ï¸ Missing <$tag> tag"
          done

      - name: ğŸŸ¥ Red-Line Check
        run: |
          grep -n -E "ERROR|FIXME|TODO" -R . || echo "âœ… No critical keywords found"

      - name: ğŸŒ CSS/JS Check
        run: |
          if [ -f style.css ]; then echo "âœ… style.css found"; fi
          if [ -f main.js ]; then echo "âœ… main.js found"; fi

  # =========================
  # ğŸ§¹ LINT & FORMAT JOB
  # =========================
  lint:
    name: ğŸ§¹ Lint & Prettier Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ§¹ ESLint
        run: |
          if [ -f .eslintrc.json ] || [ -f .eslintrc.js ]; then
            npx eslint . || echo "âš ï¸ ESLint issues found!"
          else
            echo "â„¹ï¸ No ESLint config found."
          fi

      - name: ğŸ¨ Prettier Check
        run: |
          if [ -f package.json ] && grep -q "prettier" package.json; then
            npx prettier --check "**/*.{js,css,html}" || echo "âš ï¸ Prettier formatting issues!"
          else
            echo "â„¹ï¸ Prettier not configured."
          fi

  # =========================
  # ğŸ§ª TEST JOB
  # =========================
  tests:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ”¬ Run npm tests
        run: |
          if grep -q '"test"' package.json; then
            npm test || echo "âš ï¸ Tests failed!"
          else
            echo "â„¹ï¸ No npm test script defined."
          fi

      - name: ğŸ§ª Run Python Tests
        run: |
          if [ -d tests ]; then
            python -m unittest discover tests || echo "âš ï¸ Python tests failed!"
          else
            echo "â„¹ï¸ No Python tests found."
          fi

  # =========================
  # ğŸ“Š DEBUG INFO JOB
  # =========================
  debug:
    name: ğŸ“Š Debug & Environment Info
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ–¥ï¸ System Info
        run: |
          node -v
          npm -v
          python --version
          uname -a
          df -h
          free -h

      - name: ğŸ“¦ List npm Scripts
        run: |
          if [ -f package.json ]; then
            cat package.json | grep scripts -A 20
          fi

  # =========================
  # ğŸš€ DEPLOY JOB
  # =========================
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build, inspector, lint, tests]
    environment:
      name: github-pages
    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸŒ Deploy Website
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Deployment Success
        run: |
          echo "ğŸ‰ Your site is LIVE on GitHub Pages!"
