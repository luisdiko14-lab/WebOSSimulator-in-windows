name: ğŸš€ Ultra Clean Zero-Error Deploy PRO

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # =========================
  # ğŸ” PRECHECK JOB
  # =========================
  precheck:
    name: ğŸ” Precheck & Repo Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ—‚ï¸ List All Files (Tree)
        run: |
          echo "ğŸ“ FULL FILE TREE:"
          find . -type f
          echo "âœ… File tree scan complete!"

      - name: ğŸ§¾ Validate package.json
        run: |
          if [ -f package.json ]; then
            echo "âœ… package.json found!"
            cat package.json
          else
            echo "âš ï¸ No package.json found!"
          fi

  # =========================
  # ğŸ”¨ BUILD JOB
  # =========================
  build:
    name: ğŸ”¨ Build & Prepare Site
    runs-on: ubuntu-latest
    needs: precheck

    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install || echo "âš ï¸ npm install failed!"

      - name: ğŸ› ï¸ Run Build (If Exists)
        run: |
          if grep -q '"build"' package.json; then
            echo "ğŸ› ï¸ Build script found! Running..."
            npm run build
          else
            echo "â„¹ï¸ No build script found â€” skipping build."
          fi

      - name: ğŸ§ª Run Dev Script (If Exists)
        run: |
          if grep -q '"dev"' package.json; then
            echo "ğŸ–¥ï¸ Dev script found!"
            npm run dev || echo "âš ï¸ Dev script failed!"
          else
            echo "â„¹ï¸ No dev script defined."
          fi

      - name: âš™ï¸ Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Upload Site Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  # =========================
  # ğŸ§ª FILE INSPECTOR JOB
  # =========================
  inspector:
    name: ğŸ§ª Deep File Inspector
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ§¾ Show index.html With Line Numbers
        run: |
          if [ -f index.html ]; then
            echo "ğŸ“„ index.html FOUND!"
            nl -ba index.html
          else
            echo "âŒ ERROR: index.html NOT FOUND!"
            exit 1
          fi

      - name: ğŸš¨ Scan For Common HTML Errors
        run: |
          echo "ğŸ” Scanning for common issues..."
          grep -n "<html" index.html || echo "âš ï¸ Missing <html> tag"
          grep -n "<head" index.html || echo "âš ï¸ Missing <head> tag"
          grep -n "<body" index.html || echo "âš ï¸ Missing <body> tag"

      - name: ğŸŸ¥ Red-Line Error Simulation
        run: |
          echo "ğŸŸ¥ Checking for TODO / ERROR / FIXME..."
          grep -n -E "ERROR|FIXME|TODO" -R . || echo "âœ… No red-line keywords found!"

  # =========================
  # ğŸ§¹ LINT JOB
  # =========================
  lint:
    name: ğŸ§¹ Lint & Syntax Check
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ§ª ESLint Check (If Config Exists)
        run: |
          if [ -f .eslintrc.json ] || [ -f .eslintrc.js ]; then
            echo "ğŸ§¹ ESLint config found! Running lint..."
            npx eslint . || echo "âŒ ESLint found issues!"
          else
            echo "â„¹ï¸ No ESLint config found â€” skipping lint."
          fi

  # =========================
  # ğŸ“Š DEBUG JOB
  # =========================
  debug:
    name: ğŸ“Š Ultra Debug Info
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ–¥ï¸ Show System Info
        run: |
          echo "ğŸ§  SYSTEM INFO:"
          node -v
          npm -v
          uname -a

      - name: ğŸ“¦ Show npm Scripts
        run: |
          if [ -f package.json ]; then
            echo "ğŸ“œ npm scripts:"
            cat package.json | grep scripts -A 20
          fi

  # =========================
  # ğŸš€ DEPLOY JOB
  # =========================
  deploy:
    name: ğŸš€ Deploy to GitHub Pages (FINAL BOSS)
    runs-on: ubuntu-latest
    needs: [build, inspector, lint]
    environment:
      name: github-pages

    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸŒ Deploy Website
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Success Message
        run: |
          echo "ğŸ‰ DEPLOY SUCCESS!"
          echo "ğŸš€ Your site is LIVE on GitHub Pages!"
