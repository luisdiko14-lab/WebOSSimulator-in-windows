name: ğŸš€ Mega Ultra OP CI / CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "mega-ultra-op"
  cancel-in-progress: false

jobs:
  # -----------------------------------------------------------
  # PRECHECK: detect files & features, expose outputs for jobs
  # -----------------------------------------------------------
  precheck:
    name: ğŸ” Precheck & Feature Detect
    runs-on: ubuntu-latest
    outputs:
      has_package_json: ${{ steps.set.outputs.has_package_json }}
      has_requirements: ${{ steps.set.outputs.has_requirements }}
      has_dockerfile: ${{ steps.set.outputs.has_dockerfile }}
      has_playwright: ${{ steps.set.outputs.has_playwright }}
      has_cypress: ${{ steps.set.outputs.has_cypress }}
      has_lighthouse: ${{ steps.set.outputs.has_lighthouse }}
      has_images: ${{ steps.set.outputs.has_images }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“ Short file list
        run: |
          echo "Top-level files:"
          ls -la | sed -n '1,200p'

      - name: ğŸ” Detect features and set outputs
        id: set
        run: |
          # defaults
          echo "has_package_json=false" >> $GITHUB_OUTPUT
          echo "has_requirements=false" >> $GITHUB_OUTPUT
          echo "has_dockerfile=false" >> $GITHUB_OUTPUT
          echo "has_playwright=false" >> $GITHUB_OUTPUT
          echo "has_cypress=false" >> $GITHUB_OUTPUT
          echo "has_lighthouse=false" >> $GITHUB_OUTPUT
          echo "has_images=false" >> $GITHUB_OUTPUT

          if [ -f package.json ]; then
            echo "has_package_json=true" >> $GITHUB_OUTPUT
            echo "âœ… package.json detected"
          fi

          if [ -f requirements.txt ]; then
            echo "has_requirements=true" >> $GITHUB_OUTPUT
            echo "âœ… requirements.txt detected"
          fi

          if [ -f Dockerfile ]; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
            echo "âœ… Dockerfile detected"
          fi

          if [ -f playwright.config.* ] || [ -f playwright.config.js ] || grep -q "playwright" package.json 2>/dev/null; then
            echo "has_playwright=true" >> $GITHUB_OUTPUT
            echo "âœ… Playwright config detected"
          fi

          if grep -q "cypress" package.json 2>/dev/null || [ -d cypress ]; then
            echo "has_cypress=true" >> $GITHUB_OUTPUT
            echo "âœ… Cypress detected"
          fi

          if grep -q "lhci" package.json 2>/dev/null || grep -q "lighthouse" package.json 2>/dev/null; then
            echo "has_lighthouse=true" >> $GITHUB_OUTPUT
            echo "âœ… Lighthouse / LHCI detected"
          fi

          if ls **/*.{png,jpg,jpeg,webp,svg} 1> /dev/null 2>&1; then
            echo "has_images=true" >> $GITHUB_OUTPUT
            echo "âœ… images detected"
          fi

  # -----------------------------------------------------------
  # BUILD: Node matrix + Python support, caching, build script
  # -----------------------------------------------------------
  build:
    name: ğŸ”¨ Build (Node Matrix + Python)
    runs-on: ubuntu-latest
    needs: precheck
    strategy:
      fail-fast: false
      matrix:
        node-version: ["16", "18", "20"]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: ğŸ—„ï¸ Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ matrix.node-version }}-

      - name: ğŸ“¦ Install npm dependencies (if present)
        run: |
          if [ "${{ needs.precheck.outputs.has_package_json }}" = "true" ]; then
            if [ -f package-lock.json ]; then
              npm ci --prefer-offline --no-audit --progress=false
            else
              npm install --no-audit --prefer-offline
            fi
          else
            echo "â„¹ï¸ No package.json â€” skipping npm install"
          fi

      - name: ğŸ Setup Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: ğŸ—„ï¸ Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install Python packages (if present)
        run: |
          if [ "${{ needs.precheck.outputs.has_requirements }}" = "true" ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "â„¹ï¸ No requirements.txt â€” skipping pip install"
          fi

      - name: ğŸ› ï¸ Run build script (if available)
        run: |
          if [ -f package.json ] && grep -q "\"build\"" package.json; then
            echo "ğŸ› ï¸ Running npm run build"
            npm run build
          else
            echo "â„¹ï¸ No build script found"
          fi

      - name: ğŸ” Save build artifacts list
        run: |
          echo "Top-level files after build:"
          ls -la | sed -n '1,200p'

  # -----------------------------------------------------------
  # LINT: ESLint + Prettier (fast), plus optional Python linters
  # -----------------------------------------------------------
  lint:
    name: ğŸ§¹ Lint & Format Checks
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Install lint deps (if package.json present)
        run: |
          if [ "${{ needs.precheck.outputs.has_package_json }}" = "true" ]; then
            if [ -f package-lock.json ]; then npm ci --prefer-offline --no-audit --progress=false; else npm install --no-audit --prefer-offline; fi
          else
            echo "â„¹ï¸ No package.json â€” skipping npm install for lint"
          fi

      - name: ğŸ§ª ESLint (if configured)
        run: |
          if [ -f .eslintrc.json ] || [ -f .eslintrc.js ] || grep -q "eslint" package.json 2>/dev/null; then
            npx eslint . --max-warnings=0 || echo "âš ï¸ ESLint issues detected"
          else
            echo "â„¹ï¸ ESLint not configured"
          fi

      - name: ğŸ¨ Prettier check (if configured)
        run: |
          if grep -q "prettier" package.json 2>/dev/null || [ -f .prettierrc ] || [ -f .prettierrc.json ]; then
            npx prettier --check "**/*.{js,ts,jsx,tsx,css,scss,html,json,md}" || echo "âš ï¸ Prettier issues"
          else
            echo "â„¹ï¸ Prettier not configured"
          fi

      - name: ğŸ Python lint (flake8/ruff) if requirements exist
        run: |
          if [ "${{ needs.precheck.outputs.has_requirements }}" = "true" ]; then
            python -m pip install flake8 ruff || true
            if command -v ruff >/dev/null 2>&1; then
              ruff .
            else
              flake8 . || echo "âš ï¸ flake8 issues"
            fi
          else
            echo "â„¹ï¸ No Python requirements â€” skipping Python lint"
          fi

  # -----------------------------------------------------------
  # UNIT TESTS: JS and Python (non-fatal to keep pipeline flexible)
  # -----------------------------------------------------------
  unit_tests:
    name: ğŸ§ª Unit Tests (JS + Python)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”¬ JS tests (if defined)
        run: |
          if [ -f package.json ] && grep -q "\"test\"" package.json; then
            npm test || echo "âš ï¸ JS tests failed"
          else
            echo "â„¹ï¸ No npm test script"
          fi

      - name: ğŸ”¬ Python tests (if tests folder)
        run: |
          if [ -d tests ]; then
            python -m unittest discover -v tests || echo "âš ï¸ Python tests failed"
          else
            echo "â„¹ï¸ No Python tests folder"
          fi

  # -----------------------------------------------------------
  # SECURITY SCAN: npm audit + pip check + optional safety
  # -----------------------------------------------------------
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” npm audit (if package.json)
        run: |
          if [ "${{ needs.precheck.outputs.has_package_json }}" = "true" ]; then
            npm audit --json > audit.json || true
            echo "ğŸ“ npm audit saved to audit.json"
          else
            echo "â„¹ï¸ No package.json â€” skipping npm audit"
          fi

      - name: ğŸ pip check & safety (if requirements)
        run: |
          if [ "${{ needs.precheck.outputs.has_requirements }}" = "true" ]; then
            python -m pip install safety || true
            pip check || echo "âš ï¸ pip dependency issues"
            safety check --full-report || echo "âš ï¸ safety found issues (if any)"
          else
            echo "â„¹ï¸ No requirements.txt â€” skipping pip security checks"
          fi

  # -----------------------------------------------------------
  # E2E: Playwright / Cypress (optional, gated)
  # -----------------------------------------------------------
  e2e:
    name: ğŸŒ E2E (Playwright / Cypress)
    runs-on: ubuntu-latest
    needs: [build, unit_tests]
    strategy:
      matrix:
        browser: ["chromium", "firefox"]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ” Run Playwright tests (if detected)
        if: ${{ needs.precheck.outputs.has_playwright == 'true' }}
        run: |
          npm i --no-audit @playwright/test || true
          npx playwright install --with-deps || true
          if [ -f package.json ] && grep -q "playwright" package.json 2>/dev/null; then
            npx playwright test --project=${{ matrix.browser }} || echo "âš ï¸ Playwright tests failed"
          else
            echo "â„¹ï¸ Playwright not configured"
          fi

      - name: ğŸ” Run Cypress tests (if detected)
        if: ${{ needs.precheck.outputs.has_cypress == 'true' }}
        run: |
          npm i --no-audit cypress || true
          npx cypress run || echo "âš ï¸ Cypress tests failed"

  # -----------------------------------------------------------
  # PERFORMANCE: Lighthouse (guarded) + simple perf checks
  # -----------------------------------------------------------
  performance:
    name: âš¡ Performance (Lighthouse / LHCI)
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ğŸš¦ Run LHCI autorun (if configured)
        run: |
          if [ "${{ needs.precheck.outputs.has_lighthouse }}" = "true" ]; then
            if [ -f package.json ] && grep -q "lhci" package.json 2>/dev/null; then
              npx @lhci/cli@0.10 autorun || echo "âš ï¸ LHCI autorun failed"
            else
              echo "â„¹ï¸ No LHCI script found in package.json â€” consider adding lhci config"
            fi
          else
            echo "â„¹ï¸ No Lighthouse/LHCI config detected â€” skipping"
          fi

      - name: ğŸ“ Simple perf snapshot
        run: |
          echo "Snapshot: node $(node -v), npm $(npm -v)"

  # -----------------------------------------------------------
  # ACCESSIBILITY: pa11y / axe (guarded)
  # -----------------------------------------------------------
  accessibility:
    name: â™¿ Accessibility Checks
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Install pa11y (if available)
        run: |
          if [ "${{ needs.precheck.outputs.has_package_json }}" = "true" ]; then
            npm i --no-audit -D pa11y || true
            npx pa11y http://localhost:8080 || echo "â„¹ï¸ pa11y run skipped (requires local server)"
          else
            echo "â„¹ï¸ No package.json â€” skipping pa11y"
          fi

  # -----------------------------------------------------------
  # IMAGES: optimize images if images exist
  # -----------------------------------------------------------
  image_opt:
    name: ğŸ–¼ï¸ Image Optimization
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Optimize images (if any)
        run: |
          if [ "${{ needs.precheck.outputs.has_images }}" = "true" ]; then
            npm i --no-audit -D imagemin-cli imagemin-mozjpeg imagemin-pngquant || true
            npx imagemin "**/*.{jpg,jpeg,png,webp}" --out-dir=optimized || echo "âš ï¸ imagemin failed or no images matched"
            echo "Optimized images (if any) are in ./optimized"
          else
            echo "â„¹ï¸ No images found â€” skipping image optimization"
          fi

  # -----------------------------------------------------------
  # DOCKER: build image (if Dockerfile present)
  # -----------------------------------------------------------
  docker_build:
    name: ğŸ³ Docker Build (if Dockerfile)
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.precheck.outputs.has_dockerfile == 'true' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Build Docker image
        run: |
          IMAGE_NAME="repo-image:${GITHUB_SHA::8}"
          docker build -t $IMAGE_NAME .
          echo "Built $IMAGE_NAME"

      - name: ğŸ§¾ Save image size
        run: |
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | sed -n '1,50p'

  # -----------------------------------------------------------
  # CHANGELOG + RELEASE: basic changelog draft + create release (optional)
  # -----------------------------------------------------------
  release:
    name: ğŸ“ Changelog + GitHub Release (optional)
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¾ Generate simple changelog from git
        id: changelog
        run: |
          echo "## Changelog (auto)" > CHANGELOG_AUTO.md
          git --no-pager log --oneline -n 50 >> CHANGELOG_AUTO.md
          echo "Changelog written to CHANGELOG_AUTO.md"
          echo "changelog_path=CHANGELOG_AUTO.md" >> $GITHUB_OUTPUT

      - name: ğŸš€ Create GitHub Release (if GITHUB_REF is a tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: CHANGELOG_AUTO.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # -----------------------------------------------------------
  # PACKAGE: prepare artifact and upload for Pages
  # -----------------------------------------------------------
  package:
    name: ğŸ“¦ Package & Upload Artifact for Pages
    runs-on: ubuntu-latest
    needs: [lint, unit_tests, image_opt]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¾ Detect build folder to upload
        id: artifact
        run: |
          if [ -d build ]; then
            echo "path=build" >> $GITHUB_OUTPUT
            echo "âœ… Will upload build/"
          else
            echo "path=." >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No build folder â€” will upload repo root"
          fi

      - name: ğŸ“¤ Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.artifact.outputs.path }}

  # -----------------------------------------------------------
  # DEPLOY: deploy-pages + verification
  # -----------------------------------------------------------
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: package
    environment:
      name: github-pages
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŒ Deploy site
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Deployment verification
        run: |
          echo "Pages deploy action outcome: ${{ steps.deployment.outcome || 'unknown' }}"
          echo "If deployment succeeded, your Pages site should be live."

  # -----------------------------------------------------------
  # NOTIFY: optional Slack notify (requires SLACK_WEBHOOK secret)
  # -----------------------------------------------------------
  notify:
    name: ğŸ“£ Notify (Slack) - optional
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ secrets.SLACK_WEBHOOK != '' }}
    steps:
      - name: ğŸ“¨ Send Slack notification (optional)
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: repo,commit,author
          custom_payload: |
            {
              "text": "ğŸš€ Deploy finished for *${{ github.repository }}* on branch `${{ github.ref_name }}`. (<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>)"
            }
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  # -----------------------------------------------------------
  # FINAL: summary job to print quick report in logs
  # -----------------------------------------------------------
  final_report:
    name: ğŸ“Š Final Summary
    runs-on: ubuntu-latest
    needs: [deploy, release]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¾ Print summary
        run: echo "Finished"

