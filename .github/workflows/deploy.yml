name: üöÄ Mega Ultra OP CI / CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "mega-ultra-op"
  cancel-in-progress: false

jobs:
  # -----------------------------------------------------------
  # PRECHECK: detect files & features, expose outputs for jobs
  # -----------------------------------------------------------
  precheck:
    name: üîç Precheck & Feature Detect
    runs-on: ubuntu-latest
    outputs:
      has_package_json: ${{ steps.set.outputs.has_package_json }}
      has_requirements: ${{ steps.set.outputs.has_requirements }}
      has_dockerfile: ${{ steps.set.outputs.has_dockerfile }}
      has_playwright: ${{ steps.set.outputs.has_playwright }}
      has_cypress: ${{ steps.set.outputs.has_cypress }}
      has_lighthouse: ${{ steps.set.outputs.has_lighthouse }}
      has_images: ${{ steps.set.outputs.has_images }}
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üìÅ Short file list
        run: |
          echo "Top-level files:"
          ls -la | sed -n '1,200p'

      - name: üîé Detect features and set outputs
        id: set
        run: |
          # defaults
          echo "has_package_json=false" >> $GITHUB_OUTPUT
          echo "has_requirements=false" >> $GITHUB_OUTPUT
          echo "has_dockerfile=false" >> $GITHUB_OUTPUT
          echo "has_playwright=false" >> $GITHUB_OUTPUT
          echo "has_cypress=false" >> $GITHUB_OUTPUT
          echo "has_lighthouse=false" >> $GITHUB_OUTPUT
          echo "has_images=false" >> $GITHUB_OUTPUT

          if [ -f package.json ]; then
            echo "has_package_json=true" >> $GITHUB_OUTPUT
            echo "‚úÖ package.json detected"
          fi

          if [ -f requirements.txt ]; then
            echo "has_requirements=true" >> $GITHUB_OUTPUT
            echo "‚úÖ requirements.txt detected"
          fi

          if [ -f Dockerfile ]; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Dockerfile detected"
          fi

          if [ -f playwright.config.* ] || [ -f playwright.config.js ] || grep -q "playwright" package.json 2>/dev/null; then
            echo "has_playwright=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Playwright config detected"
          fi

          if grep -q "cypress" package.json 2>/dev/null || [ -d cypress ]; then
            echo "has_cypress=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Cypress detected"
          fi

          if grep -q "lhci" package.json 2>/dev/null || grep -q "lighthouse" package.json 2>/dev/null; then
            echo "has_lighthouse=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Lighthouse / LHCI detected"
          fi

          if ls **/*.{png,jpg,jpeg,webp,svg} 1> /dev/null 2>&1; then
            echo "has_images=true" >> $GITHUB_OUTPUT
            echo "‚úÖ images detected"
          fi

  # -----------------------------------------------------------
  # BUILD: Node matrix + Python support, caching, build script
  # -----------------------------------------------------------
  build:
    name: üî® Build (Node Matrix + Python)
    runs-on: ubuntu-latest
    needs: precheck
    strategy:
      fail-fast: false
      matrix:
        node-version: ["16", "18", "20"]
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: üóÑÔ∏è Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ matrix.node-version }}-

      - name: üì¶ Install npm dependencies (if present)
        run: |
          if [ "${{ needs.precheck.outputs.has_package_json }}" = "true" ]; then
            if [ -f package-lock.json ]; then
              npm ci --prefer-offline --no-audit --progress=false
            else
              npm install --no-audit --prefer-offline
            fi
          else
            echo "‚ÑπÔ∏è No package.json ‚Äî skipping npm install"
          fi

      - name: üêç Setup Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: üóÑÔ∏è Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üì¶ Install Python packages (if present)
        run: |
          if [ "${{ needs.precheck.outputs.has_requirements }}" = "true" ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "‚ÑπÔ∏è No requirements.txt ‚Äî skipping pip install"
          fi

      - name: üõ†Ô∏è Run build script (if available)
        run: |
          if [ -f package.json ] && grep -q "\"build\"" package.json; then
            echo "üõ†Ô∏è Running npm run build"
            npm run build
          else
            echo "‚ÑπÔ∏è No build script found"
          fi

      - name: üîç Save build artifacts list
        run: |
          echo "Top-level files after build:"
          ls -la | sed -n '1,200p'

  # -----------------------------------------------------------
  # LINT: ESLint + Prettier (fast), plus optional Python linters
  # -----------------------------------------------------------
  lint:
    name: üßπ Lint & Format Checks
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üì¶ Install lint deps (if package.json present)
        run: |
          if [ "${{ needs.precheck.outputs.has_package_json }}" = "true" ]; then
            if [ -f package-lock.json ]; then npm ci --prefer-offline --no-audit --progress=false; else npm install --no-audit --prefer-offline; fi
          else
            echo "‚ÑπÔ∏è No package.json ‚Äî skipping npm install for lint"
          fi

      - name: üß™ ESLint (if configured)
        run: |
          if [ -f .eslintrc.json ] || [ -f .eslintrc.js ] || grep -q "eslint" package.json 2>/dev/null; then
            npx eslint . --max-warnings=0 || echo "‚ö†Ô∏è ESLint issues detected"
          else
            echo "‚ÑπÔ∏è ESLint not configured"
          fi

      - name: üé® Prettier check (if configured)
        run: |
          if grep -q "prettier" package.json 2>/dev/null || [ -f .prettierrc ] || [ -f .prettierrc.json ]; then
            npx prettier --check "**/*.{js,ts,jsx,tsx,css,scss,html,json,md}" || echo "‚ö†Ô∏è Prettier issues"
          else
            echo "‚ÑπÔ∏è Prettier not configured"
          fi

      - name: üêç Python lint (flake8/ruff) if requirements exist
        run: |
          if [ "${{ needs.precheck.outputs.has_requirements }}" = "true" ]; then
            python -m pip install flake8 ruff || true
            if command -v ruff >/dev/null 2>&1; then
              ruff .
            else
              flake8 . || echo "‚ö†Ô∏è flake8 issues"
            fi
          else
            echo "‚ÑπÔ∏è No Python requirements ‚Äî skipping Python lint"
          fi

  # -----------------------------------------------------------
  # UNIT TESTS: JS and Python (non-fatal to keep pipeline flexible)
  # -----------------------------------------------------------
  unit_tests:
    name: üß™ Unit Tests (JS + Python)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üî¨ JS tests (if defined)
        run: |
          if [ -f package.json ] && grep -q "\"test\"" package.json; then
            npm test || echo "‚ö†Ô∏è JS tests failed"
          else
            echo "‚ÑπÔ∏è No npm test script"
          fi

      - name: üî¨ Python tests (if tests folder)
        run: |
          if [ -d tests ]; then
            python -m unittest discover -v tests || echo "‚ö†Ô∏è Python tests failed"
          else
            echo "‚ÑπÔ∏è No Python tests folder"
          fi

  # -----------------------------------------------------------
  # SECURITY SCAN: npm audit + pip check + optional safety
  # -----------------------------------------------------------
  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîé npm audit (if package.json)
        run: |
          if [ "${{ needs.precheck.outputs.has_package_json }}" = "true" ]; then
            npm audit --json > audit.json || true
            echo "üìù npm audit saved to audit.json"
          else
            echo "‚ÑπÔ∏è No package.json ‚Äî skipping npm audit"
          fi

      - name: üêç pip check & safety (if requirements)
        run: |
          if [ "${{ needs.precheck.outputs.has_requirements }}" = "true" ]; then
            python -m pip install safety || true
            pip check || echo "‚ö†Ô∏è pip dependency issues"
            safety check --full-report || echo "‚ö†Ô∏è safety found issues (if any)"
          else
            echo "‚ÑπÔ∏è No requirements.txt ‚Äî skipping pip security checks"
          fi

  # -----------------------------------------------------------
  # E2E: Playwright / Cypress (optional, gated)
  # -----------------------------------------------------------
  e2e:
    name: üåê E2E (Playwright / Cypress)
    runs-on: ubuntu-latest
    needs: [build, unit_tests]
    strategy:
      matrix:
        browser: ["chromium", "firefox"]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üü¢ Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üîé Run Playwright tests (if detected)
        if: ${{ needs.precheck.outputs.has_playwright == 'true' }}
        run: |
          npm i --no-audit @playwright/test || true
          npx playwright install --with-deps || true
          if [ -f package.json ] && grep -q "playwright" package.json 2>/dev/null; then
            npx playwright test --project=${{ matrix.browser }} || echo "‚ö†Ô∏è Playwright tests failed"
          else
            echo "‚ÑπÔ∏è Playwright not configured"
          fi

      - name: üîé Run Cypress tests (if detected)
        if: ${{ needs.precheck.outputs.has_cypress == 'true' }}
        run: |
          npm i --no-audit cypress || true
          npx cypress run || echo "‚ö†Ô∏è Cypress tests failed"

  # -----------------------------------------------------------
  # PERFORMANCE: Lighthouse (guarded) + simple perf checks
  # -----------------------------------------------------------
  performance:
    name: ‚ö° Performance (Lighthouse / LHCI)
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: üö¶ Run LHCI autorun (if configured)
        run: |
          if [ "${{ needs.precheck.outputs.has_lighthouse }}" = "true" ]; then
            if [ -f package.json ] && grep -q "lhci" package.json 2>/dev/null; then
              npx @lhci/cli@0.10 autorun || echo "‚ö†Ô∏è LHCI autorun failed"
            else
              echo "‚ÑπÔ∏è No LHCI script found in package.json ‚Äî consider adding lhci config"
            fi
          else
            echo "‚ÑπÔ∏è No Lighthouse/LHCI config detected ‚Äî skipping"
          fi

      - name: üìù Simple perf snapshot
        run: |
          echo "Snapshot: node $(node -v), npm $(npm -v)"

  # -----------------------------------------------------------
  # ACCESSIBILITY: pa11y / axe (guarded)
  # -----------------------------------------------------------
  accessibility:
    name: ‚ôø Accessibility Checks
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Install pa11y (if available)
        run: |
          if [ "${{ needs.precheck.outputs.has_package_json }}" = "true" ]; then
            npm i --no-audit -D pa11y || true
            npx pa11y http://localhost:8080 || echo "‚ÑπÔ∏è pa11y run skipped (requires local server)"
          else
            echo "‚ÑπÔ∏è No package.json ‚Äî skipping pa11y"
          fi

  # -----------------------------------------------------------
  # IMAGES: optimize images if images exist
  # -----------------------------------------------------------
  image_opt:
    name: üñºÔ∏è Image Optimization
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Optimize images (if any)
        run: |
          if [ "${{ needs.precheck.outputs.has_images }}" = "true" ]; then
            npm i --no-audit -D imagemin-cli imagemin-mozjpeg imagemin-pngquant || true
            npx imagemin "**/*.{jpg,jpeg,png,webp}" --out-dir=optimized || echo "‚ö†Ô∏è imagemin failed or no images matched"
            echo "Optimized images (if any) are in ./optimized"
          else
            echo "‚ÑπÔ∏è No images found ‚Äî skipping image optimization"
          fi

  # -----------------------------------------------------------
  # DOCKER: build image (if Dockerfile present)
  # -----------------------------------------------------------
  docker_build:
    name: üê≥ Docker Build (if Dockerfile)
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.precheck.outputs.has_dockerfile == 'true' }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üê≥ Build Docker image
        run: |
          IMAGE_NAME="repo-image:${GITHUB_SHA::8}"
          docker build -t $IMAGE_NAME .
          echo "Built $IMAGE_NAME"

      - name: üßæ Save image size
        run: |
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | sed -n '1,50p'

  # -----------------------------------------------------------
  # CHANGELOG + RELEASE: basic changelog draft + create release (optional)
  # -----------------------------------------------------------
  release:
    name: üìù Changelog + GitHub Release (optional)
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üßæ Generate simple changelog from git
        id: changelog
        run: |
          echo "## Changelog (auto)" > CHANGELOG_AUTO.md
          git --no-pager log --oneline -n 50 >> CHANGELOG_AUTO.md
          echo "Changelog written to CHANGELOG_AUTO.md"
          echo "changelog_path=CHANGELOG_AUTO.md" >> $GITHUB_OUTPUT

      - name: üöÄ Create GitHub Release (if GITHUB_REF is a tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: CHANGELOG_AUTO.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # -----------------------------------------------------------
  # PACKAGE: prepare artifact and upload for Pages
  # -----------------------------------------------------------
  package:
    name: üì¶ Package & Upload Artifact for Pages
    runs-on: ubuntu-latest
    needs: [lint, unit_tests, image_opt]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üßæ Detect build folder to upload
        id: artifact
        run: |
          if [ -d build ]; then
            echo "path=build" >> $GITHUB_OUTPUT
            echo "‚úÖ Will upload build/"
          else
            echo "path=." >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No build folder ‚Äî will upload repo root"
          fi

      - name: üì§ Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.artifact.outputs.path }}

  # -----------------------------------------------------------
  # DEPLOY: deploy-pages + verification
  # -----------------------------------------------------------
  deploy:
    name: üöÄ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: package
    environment:
      name: github-pages
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üåç Deploy site
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ‚úÖ Deployment verification
        run: |
          echo "Pages deploy action outcome: ${{ steps.deployment.outcome || 'unknown' }}"
          echo "If deployment succeeded, your Pages site should be live."

  # -----------------------------------------------------------
  # NOTIFY: optional Slack notify (requires SLACK_WEBHOOK secret)
  # -----------------------------------------------------------
  notify:
    name: üì£ Notify (Slack) - optional
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ secrets.SLACK_WEBHOOK != '' }}
    steps:
      - name: üì® Send Slack notification (optional)
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: repo,commit,author
          custom_payload: |
            {
              "text": "üöÄ Deploy finished for *${{ github.repository }}* on branch `${{ github.ref_name }}`. (<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>)"
            }
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  # -----------------------------------------------------------
  # FINAL: summary job to print quick report in logs
  # -----------------------------------------------------------
  final_report:
    name: üìä Final Summary
    runs-on: ubuntu-latest
    needs: [deploy, release]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üßæ Print summary
        run: |
          echo "==== MEGA ULTRA OP SUMMARY ===="
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Run: $GITHUB_RUN_ID"
          echo "Triggered by: $GITHUB_ACTOR"
          echo "Precheck outputs:"
          echo " - package.json: ${{ needs.precheck.outputs.has_package_json }}"
          echo " - requirements.txt: ${{ needs.precheck.outputs.has_requirements }}"
          echo " - Dockerfile: ${{ needs.precheck.outputs.has_dockerfile }}"
          echo " - Playwright: ${{ needs.precheck.outputs.has_playwright }}"
          echo " - Cypress: ${{ needs.precheck.outputs.has_cypress }}"
          echo " - Lighthouse: ${{ needs.precheck.outputs.has_lighthouse }}"
          echo " - Images: ${{ needs.precheck.outputs.has_images }}"
          echo "==== END SUMMARY ===="

